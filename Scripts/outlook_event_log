# Outlook Remote Diagnostic Script
# This script collects diagnostic information from a remote computer to help troubleshoot Outlook freezing issues
# Run this script as an administrator with appropriate permissions

param(
    [Parameter(Mandatory=$true)]
    [string]$ComputerName
    # No credential parameter as you're already logged in with admin privileges
)

# Create a timestamp for log files
$timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
$localLogDir = "$env:USERPROFILE\Desktop\OutlookDiagnostics-$ComputerName-$timestamp"
$remoteLogDir = "C:\temp\OutlookDiagnostics-$timestamp"
$logFile = "$localLogDir\OutlookDiagnostics.log"

# Create the local log directory
New-Item -ItemType Directory -Path $localLogDir -Force | Out-Null

# Start logging
Start-Transcript -Path $logFile -Append

function Write-Log {
    param (
        [string]$Message,
        [string]$Type = "INFO"
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    "$timestamp [$Type] - $Message" | Out-File -FilePath $logFile -Append
    Write-Host "$timestamp [$Type] - $Message"
}

Write-Log "Starting Outlook diagnostic collection for remote computer: $ComputerName"

# Try to establish a remote session
try {
    Write-Log "Establishing remote PowerShell session to $ComputerName..."
    $session = New-PSSession -ComputerName $ComputerName -ErrorAction Stop
    
    # Create remote temporary directory
    Invoke-Command -Session $session -ScriptBlock {
        if (-not (Test-Path "C:\temp")) {
            New-Item -ItemType Directory -Path "C:\temp" -Force | Out-Null
        }
        New-Item -ItemType Directory -Path $using:remoteLogDir -Force | Out-Null
    }
    
    Write-Log "Remote session established successfully"
} catch {
    Write-Log "Failed to establish remote session: $($_.Exception.Message)" "ERROR"
    Write-Log "Please ensure the remote computer is online and WinRM is properly configured" "ERROR"
    Write-Log "You may need to run: Enable-PSRemoting -Force on the remote machine" "ERROR"
    Stop-Transcript
    return
}

# Check if Outlook is running on remote machine
Write-Log "Checking Outlook process on $ComputerName..."
$outlookProcess = Invoke-Command -Session $session -ScriptBlock {
    Get-Process -Name "OUTLOOK" -ErrorAction SilentlyContinue
}

if ($outlookProcess) {
    Write-Log "Outlook is currently running on $ComputerName (PID: $($outlookProcess.Id))"
} else {
    Write-Log "Outlook is not currently running on $ComputerName" "WARNING"
}

# Check Outlook version on remote machine
Write-Log "Checking Outlook version information..."
$remoteOutlookVersion = Invoke-Command -Session $session -ScriptBlock {
    $outlookVersions = @()
    $regPaths = @(
        "HKLM:\SOFTWARE\Microsoft\Office\ClickToRun\Configuration",
        "HKLM:\SOFTWARE\Microsoft\Office\16.0\Outlook\InstallRoot",
        "HKLM:\SOFTWARE\Microsoft\Office\15.0\Outlook\InstallRoot"
    )

    foreach ($path in $regPaths) {
        if (Test-Path $path) {
            try {
                $version = Get-ItemProperty -Path $path -ErrorAction SilentlyContinue
                $outlookVersions += $version
            } catch {
                # Silently continue if registry path cannot be accessed
            }
        }
    }

    # Save version info to remote file
    if ($outlookVersions.Count -gt 0) {
        $outlookVersions | Format-List | Out-File -FilePath "$using:remoteLogDir\OutlookVersion.txt"
        Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Office\ClickToRun\Configuration" -ErrorAction SilentlyContinue | 
            Out-File -FilePath "$using:remoteLogDir\OfficeVersion.txt" -Append
        return $true
    } else {
        return $false
    }
}

if ($remoteOutlookVersion) {
    Write-Log "Outlook version information collected"
} else {
    Write-Log "Could not determine Outlook version on $ComputerName" "WARNING"
}

# Check for Outlook add-ins on remote machine
Write-Log "Checking for Outlook add-ins..."
Invoke-Command -Session $session -ScriptBlock {
    $addinLogs = "$using:remoteLogDir\OutlookAddins.txt"

    $addinPaths = @(
        "HKCU:\Software\Microsoft\Office\Outlook\Addins",
        "HKLM:\Software\Microsoft\Office\Outlook\Addins",
        "HKCU:\Software\Microsoft\Office\16.0\Outlook\Addins",
        "HKLM:\Software\Microsoft\Office\16.0\Outlook\Addins",
        "HKCU:\Software\Microsoft\Office\15.0\Outlook\Addins",
        "HKLM:\Software\Microsoft\Office\15.0\Outlook\Addins"
    )

    foreach ($path in $addinPaths) {
        if (Test-Path $path) {
            "Checking add-ins in: $path" | Out-File -FilePath $addinLogs -Append
            Get-ChildItem -Path $path | ForEach-Object {
                $addinName = $_.PSChildName
                $addinDetails = Get-ItemProperty -Path $_.PSPath
                "Add-in: $addinName" | Out-File -FilePath $addinLogs -Append
                $addinDetails | Format-List | Out-File -FilePath $addinLogs -Append
                "LoadBehavior: $(if ($addinDetails.LoadBehavior -eq 3) { 'Loaded at startup (3)' } else { $addinDetails.LoadBehavior })" | Out-File -FilePath $addinLogs -Append
                "-------------------------------" | Out-File -FilePath $addinLogs -Append
            }
        }
    }
}

# Check for crashed Outlook processes or hanging instances
Write-Log "Checking for hung or crashed Outlook processes..."
Invoke-Command -Session $session -ScriptBlock {
    Get-WinEvent -LogName "Application" -MaxEvents 100 -ErrorAction SilentlyContinue | Where-Object { 
        $_.Message -like "*outlook*" -and ($_.LevelDisplayName -eq "Error" -or $_.LevelDisplayName -eq "Warning") 
    } | Format-List | Out-File -FilePath "$using:remoteLogDir\OutlookEventLogs.txt"
}

# Check system resources on remote machine
Write-Log "Checking system resources on $ComputerName..."
Invoke-Command -Session $session -ScriptBlock {
    # Check disk space
    Get-WmiObject Win32_LogicalDisk | Where-Object { $_.DriveType -eq 3 } | 
        Select-Object DeviceID, @{Name="Size(GB)";Expression={[math]::Round($_.Size/1GB,2)}}, @{Name="FreeSpace(GB)";Expression={[math]::Round($_.FreeSpace/1GB,2)}}, @{Name="PercentFree";Expression={[math]::Round(($_.FreeSpace/$_.Size)*100,2)}} | 
        Format-Table | Out-File -FilePath "$using:remoteLogDir\DiskSpace.txt"

    # Check memory
    Get-CimInstance Win32_PhysicalMemory | Measure-Object -Property Capacity -Sum | 
        Select-Object @{Name="TotalRAM(GB)";Expression={[math]::Round($_.Sum/1GB,2)}} | 
        Format-Table | Out-File -FilePath "$using:remoteLogDir\Memory.txt" -Append
    
    # Get processor info
    Get-CimInstance Win32_Processor | Select-Object Name, NumberOfCores, MaxClockSpeed, CurrentClockSpeed |
        Format-Table | Out-File -FilePath "$using:remoteLogDir\Processor.txt"
}

# Check for each Outlook user profile on the remote machine
Write-Log "Checking Outlook user profiles..."
Invoke-Command -Session $session -ScriptBlock {
    # Find all user profiles on the system
    $userProfiles = Get-ChildItem -Path "C:\Users" -Directory
    
    foreach ($userProfile in $userProfiles) {
        $outlookPath = Join-Path -Path $userProfile.FullName -ChildPath "AppData\Local\Microsoft\Outlook"
        
        if (Test-Path $outlookPath) {
            # Check for Outlook data files
            $pstFiles = Get-ChildItem -Path $outlookPath -Filter "*.pst" -ErrorAction SilentlyContinue
            $ostFiles = Get-ChildItem -Path $outlookPath -Filter "*.ost" -ErrorAction SilentlyContinue
            
            if ($pstFiles -or $ostFiles) {
                "User Profile: $($userProfile.Name)" | Out-File -FilePath "$using:remoteLogDir\OutlookDataFiles.txt" -Append
                
                "PST Files:" | Out-File -FilePath "$using:remoteLogDir\OutlookDataFiles.txt" -Append
                $pstFiles | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}}, LastWriteTime, FullName | 
                    Format-Table -AutoSize | Out-File -FilePath "$using:remoteLogDir\OutlookDataFiles.txt" -Append
                
                "OST Files:" | Out-File -FilePath "$using:remoteLogDir\OutlookDataFiles.txt" -Append
                $ostFiles | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}}, LastWriteTime, FullName | 
                    Format-Table -AutoSize | Out-File -FilePath "$using:remoteLogDir\OutlookDataFiles.txt" -Append
                
                "----------------------------------------" | Out-File -FilePath "$using:remoteLogDir\OutlookDataFiles.txt" -Append
            }
        }
    }
}

# Check notification related issues
Write-Log "Checking notification related issues..."
Invoke-Command -Session $session -ScriptBlock {
    # Check Windows notification settings
    Get-WinEvent -LogName "Microsoft-Windows-Shell-Core/Operational" -MaxEvents 50 -ErrorAction SilentlyContinue | 
        Where-Object { $_.Message -like "*notification*" -or $_.Message -like "*shell*" } | 
        Format-List | Out-File -FilePath "$using:remoteLogDir\NotificationLogs.txt"
}

# Check for performance issues when Outlook is running
if ($outlookProcess) {
    Write-Log "Collecting performance data for running Outlook process on $ComputerName..."
    Invoke-Command -Session $session -ScriptBlock {
        Get-Counter -Counter "\Process(outlook*)\% Processor Time", "\Process(outlook*)\Working Set", "\Process(outlook*)\Thread Count" -MaxSamples 5 -ErrorAction SilentlyContinue | 
            Format-List | Out-File -FilePath "$using:remoteLogDir\OutlookPerformance.txt"
    }
}

# Check for Windows Updates that might affect Outlook
Write-Log "Checking recent Windows Updates..."
Invoke-Command -Session $session -ScriptBlock {
    Get-HotFix | Sort-Object -Property InstalledOn -Descending | Select-Object -First 20 | 
        Format-Table -AutoSize | Out-File -FilePath "$using:remoteLogDir\RecentUpdates.txt"
}

# Generate diagnostic report for send/receive operations
Write-Log "Checking Outlook send/receive logs..."
Invoke-Command -Session $session -ScriptBlock {
    # Try to find send/receive logs for all user profiles
    $userProfiles = Get-ChildItem -Path "C:\Users" -Directory
    
    foreach ($userProfile in $userProfiles) {
        $sendReceiveLogs = Join-Path -Path $userProfile.FullName -ChildPath "AppData\Local\Temp\Outlook Logging"
        
        if (Test-Path $sendReceiveLogs) {
            $userLogDir = "$using:remoteLogDir\SendReceiveLogs\$($userProfile.Name)"
            New-Item -ItemType Directory -Path $userLogDir -Force | Out-Null
            
            # Copy the most recent log files (last 10 days)
            Get-ChildItem -Path $sendReceiveLogs -File -Recurse | 
                Where-Object { $_.LastWriteTime -gt (Get-Date).AddDays(-10) } | 
                ForEach-Object {
                    $destPath = $_.FullName.Replace($sendReceiveLogs, $userLogDir)
                    $destDir = Split-Path -Path $destPath -Parent
                    
                    if (-not (Test-Path $destDir)) {
                        New-Item -ItemType Directory -Path $destDir -Force | Out-Null
                    }
                    
                    Copy-Item -Path $_.FullName -Destination $destPath -Force
                }
        }
    }
}

# Generate recommendations
Write-Log "Generating recommendations..."
$recommendationsText = @"
Outlook Freezing Troubleshooting Recommendations:

1. Notification Related Issues:
   - Check Windows notification settings for Outlook
   - Try disabling Outlook desktop notifications temporarily (File > Options > Mail > Message arrival)
   - Update Windows to ensure notification system is not affected by known bugs

2. Add-in Related Issues:
   - Start Outlook in Safe Mode (hold CTRL while starting Outlook) to see if the issue persists
   - If issue is resolved in Safe Mode, disable add-ins one by one to identify the problematic one
   - Common problematic add-ins: Antivirus scanners, Meeting plugins, Social connectors

3. Data File Issues:
   - Large PST/OST files (>10GB) can cause performance problems 
   - Use "Mailbox Cleanup" to reduce size or archive older items
   - Check for data file corruption using Scanpst.exe

4. Performance Issues:
   - Check system resources (RAM, CPU, Disk space)
   - Close other applications to free up resources
   - Consider hardware upgrades if system is consistently at capacity

5. Outlook Cache Issues:
   - In Safe Mode, go to Control Panel > Mail > Email Accounts > Data Files
   - Note location of OST file, close Outlook, and rename the OST file
   - Restart Outlook to rebuild the OST file (will download from server)

6. Network Related Issues:
   - Test network connection stability and speed
   - Check for VPN issues if applicable
   - Verify Exchange server connection is stable

7. Specific to Email Notifications Issues:
   - Check Windows notification center settings
   - Try resetting the notification system: Get-Process RuntimeBroker | Restart-Service
   - Verify Desktop Alert settings in Outlook (Duration and transparency)

8. Navigation Freezes:
   - Try reducing the number of items per folder using AutoArchive
   - Disable RSS feeds and social connector if enabled
   - Try switching to Offline mode temporarily to test if it's a server synchronization issue
"@

Invoke-Command -Session $session -ScriptBlock {
    $using:recommendationsText | Out-File -FilePath "$using:remoteLogDir\Recommendations.txt"
}

# Copy all diagnostic information from remote computer to local
Write-Log "Copying diagnostic information from $ComputerName to local computer..."
try {
    Copy-Item -Path "$remoteLogDir\*" -Destination $localLogDir -FromSession $session -Recurse -Force
    Write-Log "Successfully copied diagnostic information to $localLogDir"
} catch {
    Write-Log "Error copying diagnostic information: $($_.Exception.Message)" "ERROR"
}

# Clean up remote temporary directory
Write-Log "Cleaning up temporary files on $ComputerName..."
Invoke-Command -Session $session -ScriptBlock {
    Remove-Item -Path $using:remoteLogDir -Recurse -Force -ErrorAction SilentlyContinue
}

# Close remote session
Write-Log "Closing remote session to $ComputerName..."
Remove-PSSession -Session $session

Write-Log "Diagnostic collection completed. Results are saved to: $localLogDir"
Write-Log "Please check the diagnostic files for potential causes of Outlook freezing"

Stop-Transcript

Write-Host ""
Write-Host "================================================================================" -ForegroundColor Green
Write-Host "Diagnostic information has been collected and saved to: $localLogDir" -ForegroundColor Green  
Write-Host "Please review these files to identify potential causes of Outlook freezing issues" -ForegroundColor Green
Write-Host "================================================================================" -ForegroundColor Green
